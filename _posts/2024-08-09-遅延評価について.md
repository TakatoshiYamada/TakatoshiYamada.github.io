---
layout: post
title: 遅延評価について
date: 2024-08-09
categories: [TIL]
tags: [ruby]
---

Enumの復習をしていたら遅延評価について気になったので別項目にわけて記載する。

## 気になったコード

```ruby
enum = (1..Float::INFINITY).lazy.select { |x| x % 3 == 0 }.first(10)
puts enum.inspect
# 出力: [3, 6, 9, 12, 15, 18, 21, 24, 27, 30]
```

このコードは、無限の範囲 (1..Float::INFINITY) から始まり、3の倍数を選択し、最初の10個の3の倍数を取得するものです。
具体的には、lazy を使用して遅延評価を行うことで、無限の範囲を効率的に処理しています。

## 無限の範囲 (1..Float::INFINITY)

```ruby
(1..Float::INFINITY)
```

これは1から無限までの範囲を表します。
この範囲は非常に大きいため、通常の範囲操作では扱いきれません。

## 遅延評価 lazy

```ruby
(1..Float::INFINITY).lazy
```

lazy メソッドを使うことで、範囲オブジェクトが遅延評価のモードに入ります。
これにより、必要な要素だけを順次評価して取得することができます。
遅延評価を使うことで、無限の範囲でも実行時にすべての要素を生成することなく処理できます。

## 条件に一致する要素の選択 select

```ruby
(1..Float::INFINITY).lazy.select { |x| x % 3 == 0 }
```

select メソッドは、ブロックの条件に一致する要素を選択します。
この場合、3の倍数 (x % 3 == 0) が条件です。
無限の範囲から3の倍数を選び出します。

## 最初の10個の要素を取得 first(10)

```ruby
(1..Float::INFINITY).lazy.select { |x| x % 3 == 0 }.first(10)
```

first(10) メソッドは、選択された要素の中から最初の10個の要素を取得します。
この部分で、実際に最初の10個の3の倍数が評価されて取得されます。

## 結果を表示 inspect

```ruby
puts enum.inspect
```

enum は最初の10個の3の倍数を含む配列です。
inspect メソッドを使って、配列の内容を文字列として表示します。

## 具体的な評価の流れ
1. 要素 1 の評価
- (1..Float::INFINITY) の最初の要素である 1 を取り出し、x % 3 == 0 を評価します。
- 1 % 3 == 0 は false なので、この要素は選択されません。

2. 要素 2 の評価
- 次に 2 を取り出し、x % 3 == 0 を評価します。
- 2 % 3 == 0 は false なので、この要素も選択されません。

3. 要素 3 の評価
- 次に 3 を取り出し、x % 3 == 0 を評価します。
- 3 % 3 == 0 は true なので、この要素は選択されます。
- リストに 3 を追加。

4. 要素 4 の評価
- 次に 4 を取り出し、x % 3 == 0 を評価します。
- 4 % 3 == 0 は false なので、この要素は選択されません。

5. 要素 5 の評価
- 次に 5 を取り出し、x % 3 == 0 を評価します。
- 5 % 3 == 0 は false なので、この要素も選択されません。

6. 要素 6 の評価
- 次に 6 を取り出し、x % 3 == 0 を評価します。
- 6 % 3 == 0 は true なので、この要素は選択されます。
- リストに 6 を追加。

このプロセスは、最初の10個の3の倍数が見つかるまで続きます。

## 出力結果
```ruby
# 出力: [3, 6, 9, 12, 15, 18, 21, 24, 27, 30]
```

この結果は、無限の範囲から遅延評価と選択を組み合わせて効率的に取得された、最初の10個の3の倍数です。

この方法により、無限の範囲を扱いながらも計算資源を無駄にせず、必要な部分だけを効率的に処理することができます。